<div class="admin-shell">
  <app-admin-sidebar></app-admin-sidebar>

  <div class="admin-content">
    <app-admin-topbar></app-admin-topbar>

    <main class="dashboard-main">
      <!-- ==================== HEADER ==================== -->
      <header class="dashboard-header">
        <div>
          <h1 class="title">Orders Control Panel</h1>
          <p class="subtitle">View and manage all customer hosting orders</p>
        </div>
        <div class="header-actions">
          <button class="btn-primary" (click)="toggleCreateForm()">
            <i class="fas" [class.fa-times]="showCreateForm" [class.fa-plus]="!showCreateForm"></i>
            {{ showCreateForm ? 'Cancel' : 'Create New Order' }}
          </button>
        </div>
      </header>

      <!-- ==================== CREATE ORDER FORM ==================== -->
      <div class="card" *ngIf="showCreateForm" style="margin-bottom:32px; animation: slideDown 0.4s ease;">
        <div class="card-body">
          <h2 style="margin:0 0 24px; font-size:20px; font-weight:700; color:#1e293b;">
            Create New Order
          </h2>

          <form [formGroup]="orderForm" (ngSubmit)="createOrder()">

            <!-- Customer Information -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-user"></i>
                Customer Information
              </h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>Customer Name <span class="required">*</span></label>
                  <input formControlName="customerName" placeholder="Ahmed Mohamed" type="text" />
                  <small class="error-text" *ngIf="orderForm.get('customerName')?.invalid && orderForm.get('customerName')?.touched">
                    Name is required (min 2 characters)
                  </small>
                </div>
                <div class="form-group">
                  <label>Phone Number <span class="required">*</span></label>
                  <input formControlName="phoneNumber" placeholder="01001234567" type="tel" />
                  <small class="error-text" *ngIf="orderForm.get('phoneNumber')?.invalid && orderForm.get('phoneNumber')?.touched">
                    Enter valid Egyptian phone number
                  </small>
                </div>
              </div>
            </div>

            <!-- Operating System Selection -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-desktop"></i>
                Operating System <span class="required">*</span>
              </h3>
              <div class="os-selection">
                <label *ngFor="let os of operatingSystems" class="os-card" [class.selected]="orderForm.get('OS')?.value === os.value">
                  <input type="radio" formControlName="OS" [value]="os.value" hidden />
                  <div class="os-content">
                    <i [class]="os.icon"></i>
                    <span>{{ os.label }}</span>
                  </div>
                  <div class="check-icon" *ngIf="orderForm.get('OS')?.value === os.value">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-credit-card"></i>
                Payment Method <span class="required">*</span>
              </h3>
              <div class="payment-methods">
                <label *ngFor="let method of paymentMethods" class="payment-method-card" [class.selected]="orderForm.get('paymentMethod')?.value === method.value">
                  <input type="radio" formControlName="paymentMethod" [value]="method.value" hidden />
                  <div class="method-content">
                    <i class="fas" [class]="method.icon"></i>
                    <span>{{ method.label }}</span>
                  </div>
                  <div class="check-icon" *ngIf="orderForm.get('paymentMethod')?.value === method.value">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>
              </div>
              <small class="error-text" *ngIf="orderForm.get('paymentMethod')?.invalid && orderForm.get('paymentMethod')?.touched">
                Please select a payment method
              </small>
            </div>

            <!-- Product Type Selection -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-server"></i>
                Product Type <span class="required">*</span>
              </h3>
              <div class="product-type-selector">
                <label class="product-type-card" [class.selected]="selectedProductType === 'vps'">
                  <input type="radio" formControlName="productType" value="vps" hidden />
                  <div class="type-icon vps-icon">
                    <i class="fas fa-server"></i>
                  </div>
                  <div class="type-info">
                    <strong>VPS Plans</strong>
                    <small>Virtual Private Servers</small>
                  </div>
                  <div class="check-icon" *ngIf="selectedProductType === 'vps'">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>

                <label class="product-type-card" [class.selected]="selectedProductType === 'dedicated'">
                  <input type="radio" formControlName="productType" value="dedicated" hidden />
                  <div class="type-icon dedicated-icon">
                    <i class="fas fa-microchip"></i>
                  </div>
                  <div class="type-info">
                    <strong>Dedicated Servers</strong>
                    <small>Bare Metal Servers</small>
                  </div>
                  <div class="check-icon" *ngIf="selectedProductType === 'dedicated'">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>
              </div>
            </div>

            <!-- VPS Selection -->
            <div class="form-section" *ngIf="selectedProductType === 'vps'">
              <h3 class="section-title">
                <i class="fas fa-list"></i>
                Choose VPS Plan <span class="required">*</span>
              </h3>
              <div class="form-group">
                <select formControlName="selectedVps">
                  <option [ngValue]="null" disabled>— Select a VPS Plan —</option>
                  <option *ngFor="let vps of vpsList" [value]="vps.id">
                    {{ vps.name }} — {{ vps.cores }} Cores • {{ vps.ramGB }}GB RAM • {{ vps.storageGB }}GB {{ vps.storageType || 'NVMe' }} • ${{ vps.price }}/mo
                  </option>
                </select>
              </div>
            </div>

            <!-- Dedicated Selection -->
            <div class="form-section" *ngIf="selectedProductType === 'dedicated'">
              <h3 class="section-title">
                <i class="fas fa-list"></i>
                Choose Dedicated Server <span class="required">*</span>
              </h3>
              <div class="form-group">
                <select formControlName="selectedDedicated">
                  <option [ngValue]="null" disabled>— Select a Dedicated Server —</option>
                  <option *ngFor="let ded of dedicatedList" [value]="ded.id">
                    {{ ded.name }} — {{ ded.cpuModel || ded.cores + ' Cores' }} • {{ ded.ramGB }}GB RAM • ${{ ded.price }}/mo
                  </option>
                </select>
              </div>
            </div>

            <!-- Payment Proof -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-image"></i>
                Payment Proof (Optional)
              </h3>
              <div class="form-group">
                <div class="file-upload-area">
                  <input #fileInput type="file" accept="image/*" (change)="onFileChange($event)" id="fileUpload" />
                  <label for="fileUpload" class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span *ngIf="!orderForm.get('paymentImage')?.value">Click to upload screenshot</span>
                    <span *ngIf="orderForm.get('paymentImage')?.value" style="color:#16a34a; font-weight:600;">
                      <i class="fas fa-check-circle"></i> {{ orderForm.get('paymentImage')?.value.name }}
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div style="margin-top:32px; display:flex; gap:12px; justify-content:flex-end;">
              <button type="button" class="btn-outline" (click)="toggleCreateForm()">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button type="submit" class="btn-primary" [disabled]="isLoading || loadingProducts || orderForm.invalid">
                <i class="fas" [class.fa-spinner]="isLoading || loadingProducts" [class.fa-spin]="isLoading || loadingProducts" [class.fa-check]="!isLoading && !loadingProducts"></i>
                <span *ngIf="loadingProducts">Loading Plans...</span>
                <span *ngIf="isLoading && !loadingProducts">Creating Order...</span>
                <span *ngIf="!isLoading && !loadingProducts">Create Order</span>
              </button>
            </div>
          </form>

          <div class="alert-danger" *ngIf="error">
            <i class="fas fa-exclamation-circle"></i>
            <span>{{ error }}</span>
          </div>
          <div class="alert-success" *ngIf="message">
            <i class="fas fa-check-circle"></i>
            <span>{{ message }}</span>
          </div>
        </div>
      </div>

      <!-- ==================== ORDERS TABLE ==================== -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-header">
            <h2>
              <i class="fas fa-list-alt"></i>
              All Orders
              <span class="count-badge">{{ orders.length }}</span>
            </h2>
          </div>

          <div *ngIf="orders.length === 0" class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No orders yet</h3>
            <p>Click "Create New Order" to add your first order.</p>
          </div>

          <div class="table-responsive" *ngIf="orders.length > 0">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>OS</th>
                  <th>Payment</th>
                  <th>Product</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let o of orders">
                  <td><code class="id-badge">#{{ o.id }}</code></td>
                  <td><strong>{{ o.customerName }}</strong></td>
                  <td>
                    <a [href]="'https://wa.me/' + o.phoneNumber" target="_blank" class="phone-link">
                      <i class="fab fa-whatsapp"></i> {{ o.phoneNumber }}
                    </a>
                  </td>
                  <td>
                    <span class="os-badge" [class.linux]="o.OS === 'linux'" [class.windows]="o.OS === 'windows'">
                      {{ o.OS === 'linux' ? 'Linux' : 'Windows' }}
                    </span>
                  </td>
                  <td>
                    <span class="payment-badge">{{ getPaymentMethodLabel(o.paymentMethod) }}</span>
                  </td>
                  <td>
                    <span class="product-badge" [class]="getProductBadgeClass(o)">
                      {{ getProductName(o) }}
                    </span>
                  </td>
                  <td>{{ o.createdAt | date:'MMM d, y • h:mm a' }}</td>
                  <td>
                    <button class="btn-icon" (click)="viewOrder(o)" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ==================== ORDER DETAILS MODAL ==================== -->
<div class="modal-backdrop" *ngIf="selectedOrder || isLoadingDetails" (click)="closeDetails()"></div>

<div class="modal" *ngIf="selectedOrder || isLoadingDetails" (click)="$event.stopPropagation()">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fas fa-file-invoice"></i> Order #{{ selectedOrder?.id || '...' }}</h2>
      <button class="btn-icon" (click)="closeDetails()" title="Close">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div *ngIf="isLoadingDetails" class="text-center py-5">
        <div class="spinner"></div>
        <p style="color:#64748b; font-weight:500;">Loading order details...</p>
      </div>

      <div *ngIf="selectedOrder && !isLoadingDetails">
        <!-- Customer Information -->
        <div class="detail-section">
          <h3 class="detail-section-title"><i class="fas fa-user"></i> Customer Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Name</span>
              <span class="detail-value">{{ selectedOrder.customerName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Phone</span>
              <a [href]="'https://wa.me/' + selectedOrder.phoneNumber" target="_blank" class="phone-link">
                <i class="fab fa-whatsapp"></i> {{ selectedOrder.phoneNumber }}
              </a>
            </div>
            <div class="detail-item">
              <span class="detail-label">Operating System</span>
              <span class="os-badge" [class.linux]="selectedOrder.OS === 'linux'" [class.windows]="selectedOrder.OS === 'windows'">
                {{ selectedOrder.OS === 'linux' ? 'Linux' : 'Windows' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Payment Method</span>
              <span class="payment-badge">{{ getPaymentMethodLabel(selectedOrder.paymentMethod) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Date</span>
              <span class="detail-value">
                {{ selectedOrder.createdAt | date:'fullDate' }} at {{ selectedOrder.createdAt | date:'shortTime' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Product Details -->
        <div class="detail-section" *ngIf="selectedOrder.vps || selectedOrder.dedicated">
          <h3 class="detail-section-title">
            <i class="fas fa-server"></i>
            {{ selectedOrder.vps ? 'VPS Plan' : 'Dedicated Server' }} Details
          </h3>
          <div class="product-details-card">
            <div class="product-header">
              <h4>{{ selectedOrder.vps?.name || selectedOrder.dedicated?.name }}</h4>
              <div class="product-price">
                ${{ selectedOrder.vps?.price || selectedOrder.dedicated?.price }}/month
              </div>
            </div>
            <div class="specs-grid">
              <div class="spec-item">
                <strong><i class="fas fa-microchip"></i> {{ selectedOrder.vps ? 'CPU Cores' : 'CPU' }}</strong>
                <span>
                  {{ selectedOrder.vps
                      ? (selectedOrder.vps.cores + ' vCPU')
                      : (selectedOrder.dedicated?.cpuModel || (selectedOrder.dedicated?.cores + ' Cores')) }}
                </span>
              </div>
              <div class="spec-item">
                <strong><i class="fas fa-memory"></i> RAM</strong>
                <span>{{ selectedOrder.vps?.ramGB || selectedOrder.dedicated?.ramGB }} GB</span>
              </div>
              <div class="spec-item">
                <strong><i class="fas fa-hdd"></i> Storage</strong>
                <span *ngIf="selectedOrder.vps">
                  {{ selectedOrder.vps.storageGB }} GB {{ selectedOrder.vps.storageType || 'NVMe' }}
                </span>
                <span *ngIf="selectedOrder.dedicated">
                  {{ selectedOrder.dedicated.storage || 'Multiple NVMe Drives' }}
                </span>
              </div>
              <div class="spec-item">
                <strong><i class="fas fa-network-wired"></i> Connection</strong>
                <span>{{ selectedOrder.vps?.connectionSpeed || selectedOrder.dedicated?.connectionSpeed || '1 Gbps' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="detail-section" *ngIf="selectedOrder.description">
          <h3 class="detail-section-title">
            <i class="fas fa-file-alt"></i> Order Summary
          </h3>
          <div class="description-box">
            <pre>{{ selectedOrder.description }}</pre>
          </div>
        </div>

        <!-- Payment Proof -->
        <div class="detail-section" *ngIf="selectedOrder.paymentConfirmationImageUrl">
          <h3 class="detail-section-title">
            <i class="fas fa-receipt"></i> Payment Confirmation
          </h3>
          <div class="payment-proof">
            <img [src]="selectedOrder.paymentConfirmationImageUrl" alt="Payment proof" />
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-primary" (click)="closeDetails()">
        <i class="fas fa-check"></i> Close
      </button>
    </div>
  </div>
</div>
