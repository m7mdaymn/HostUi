<div class="admin-shell">
  <app-admin-sidebar></app-admin-sidebar>

  <div class="admin-content">
    <app-admin-topbar></app-admin-topbar>

    <main class="dashboard-main">
      <header class="dashboard-header">
        <div>
          <h1 class="title">Orders Control Panel</h1>
          <p class="subtitle">View and manage all customer hosting orders</p>
        </div>
        <div class="header-actions">
          <button class="btn-primary" (click)="toggleCreateForm()">
            <i class="fas" [class.fa-times]="showCreateForm" [class.fa-plus]="!showCreateForm"></i>
            {{ showCreateForm ? 'Cancel' : 'Create New Order' }}
          </button>
        </div>
      </header>

      <!-- CREATE ORDER FORM -->
      <div class="card" *ngIf="showCreateForm" style="margin-bottom:32px; animation: slideDown 0.4s ease;">
        <div class="card-body">
          <h2 style="margin:0 0 24px; font-size:20px; font-weight:700; color:#1e293b;">
            <i class="fas fa-plus-circle" style="color:#3b82f6;"></i> Create New Order
          </h2>

          <form [formGroup]="orderForm" (ngSubmit)="createOrder()">
            <!-- Customer Information -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-user"></i> Customer Information
              </h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>Customer Name <span class="required">*</span></label>
                  <input formControlName="customerName" placeholder="Ahmed Mohamed" />
                  <small class="error-text" *ngIf="orderForm.get('customerName')?.invalid && orderForm.get('customerName')?.touched">
                    Name is required (min 2 characters)
                  </small>
                </div>
                <div class="form-group">
                  <label>Phone Number <span class="required">*</span></label>
                  <input formControlName="phoneNumber" placeholder="+201234567890" />
                  <small class="error-text" *ngIf="orderForm.get('phoneNumber')?.invalid && orderForm.get('phoneNumber')?.touched">
                    Valid phone number required
                  </small>
                </div>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-credit-card"></i> Payment Method
              </h3>
              <div class="payment-methods">
                <label
                  *ngFor="let method of paymentMethods"
                  class="payment-method-card"
                  [class.selected]="orderForm.get('paymentMethod')?.value === method.value">
                  <input
                    type="radio"
                    formControlName="paymentMethod"
                    [value]="method.value"
                    style="display: none;">
                  <div class="method-content">
                    <i class="fas" [class]="method.icon"></i>
                    <span>{{ method.label }}</span>
                  </div>
                  <div class="check-icon" *ngIf="orderForm.get('paymentMethod')?.value === method.value">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>
              </div>
              <small class="error-text" *ngIf="orderForm.get('paymentMethod')?.invalid && orderForm.get('paymentMethod')?.touched">
                Please select a payment method
              </small>
            </div>

            <!-- Product Selection -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-server"></i> Select Product Type
              </h3>
              <div class="product-type-selector">
                <label class="product-type-card" [class.selected]="selectedProductType === 'vps'">
                  <input type="radio" formControlName="productType" value="vps" style="display: none;">
                  <div class="type-icon vps-icon">
                    <i class="fas fa-server"></i>
                  </div>
                  <div class="type-info">
                    <strong>VPS Plans</strong>
                    <small>Virtual Private Servers</small>
                  </div>
                  <div class="check-icon" *ngIf="selectedProductType === 'vps'">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>

                <label class="product-type-card" [class.selected]="selectedProductType === 'dedicated'">
                  <input type="radio" formControlName="productType" value="dedicated" style="display: none;">
                  <div class="type-icon dedicated-icon">
                    <i class="fas fa-microchip"></i>
                  </div>
                  <div class="type-info">
                    <strong>Dedicated Servers</strong>
                    <small>Bare Metal Servers</small>
                  </div>
                  <div class="check-icon" *ngIf="selectedProductType === 'dedicated'">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </label>
              </div>
            </div>

            <!-- VPS Selection -->
            <div class="form-section" *ngIf="selectedProductType === 'vps'">
              <h3 class="section-title">
                <i class="fas fa-list"></i> Choose VPS Plan
              </h3>
              <div class="form-group">
                <select formControlName="selectedVps">
                  <option [ngValue]="null" disabled selected>— Select a VPS Plan —</option>
                  <option *ngFor="let vps of vpsList" [value]="vps.id">
                    {{ vps.name }} — {{ vps.cores }}vCPU / {{ vps.ramGB }}GB RAM / {{ vps.storageGB }}GB — ${{ vps.price }}/month
                  </option>
                </select>
              </div>
            </div>

            <!-- Dedicated Selection -->
            <div class="form-section" *ngIf="selectedProductType === 'dedicated'">
              <h3 class="section-title">
                <i class="fas fa-list"></i> Choose Dedicated Server
              </h3>
              <div class="form-group">
                <select formControlName="selectedDedicated">
                  <option [ngValue]="null" disabled selected>— Select a Dedicated Server —</option>
                  <option *ngFor="let ded of dedicatedList" [value]="ded.id">
                    {{ ded.name }} — {{ ded.cores }} Cores / {{ ded.ramGB }}GB RAM — ${{ ded.price }}/month
                  </option>
                </select>
              </div>
            </div>

            <!-- Payment Proof -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fas fa-image"></i> Payment Proof (Optional)
              </h3>
              <div class="form-group">
                <div class="file-upload-area">
                  <input #fileInput type="file" accept="image/*" (change)="onFileChange($event)" id="fileUpload" />
                  <label for="fileUpload" class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span *ngIf="!orderForm.get('paymentImage')?.value">Click to upload payment screenshot</span>
                    <span *ngIf="orderForm.get('paymentImage')?.value" style="color:#16a34a;">
                      <i class="fas fa-check-circle"></i> {{ orderForm.get('paymentImage')?.value.name }}
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div style="margin-top:32px; display:flex; gap:12px; justify-content:flex-end;">
              <button type="button" class="btn-outline" (click)="toggleCreateForm()">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button
                type="submit"
                class="btn-primary"
                [disabled]="isLoading || loadingProducts || orderForm.invalid">
                <span *ngIf="loadingProducts">
                  <span class="spinner-small"></span> Loading Plans...
                </span>
                <span *ngIf="isLoading && !loadingProducts">
                  <span class="spinner-small"></span> Creating...
                </span>
                <span *ngIf="!isLoading && !loadingProducts">
                  <i class="fas fa-check"></i> Create Order
                </span>
              </button>
            </div>
          </form>

          <div class="alert-danger" *ngIf="error">
            <i class="fas fa-exclamation-triangle"></i> {{ error }}
          </div>
          <div class="alert-success" *ngIf="message">
            <i class="fas fa-check-circle"></i> {{ message }}
          </div>
        </div>
      </div>

      <!-- ORDERS TABLE -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-header">
            <h2>
              <i class="fas fa-shopping-cart"></i> All Orders
              <span class="count-badge">{{ orders.length }}</span>
            </h2>
          </div>

          <div *ngIf="orders.length === 0" class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No orders yet</h3>
            <p>Click the "Create New Order" button above to get started.</p>
          </div>

          <div class="table-responsive" *ngIf="orders.length">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>Payment</th>
                  <th>Product</th>
                  <th>Date</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let o of orders">
                  <td>
                    <code class="id-badge">#{{ o.id }}</code>
                  </td>
                  <td>
                    <div class="user-info">
                      <div class="name">{{ o.customerName }}</div>
                    </div>
                  </td>
                  <td>
                    <a [href]="'https://wa.me/' + o.phoneNumber" target="_blank" class="phone-link">
                      <i class="fab fa-whatsapp"></i> {{ o.phoneNumber }}
                    </a>
                  </td>
                  <td>
                    <span class="payment-badge">
                      <i class="fas" [class]="getPaymentMethodIcon(o.paymentMethod)"></i>
                      {{ getPaymentMethodLabel(o.paymentMethod) }}
                    </span>
                  </td>
                  <td>
                    <span class="product-badge" [class]="getProductBadgeClass(o)">
                      {{ getProductName(o) }}
                    </span>
                  </td>
                  <td>{{ o.createdAt | date:'MMM d, y • h:mm a' }}</td>
                  <td class="text-center">
                    <button class="btn-icon" (click)="viewOrder(o)" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ORDER DETAILS MODAL -->
<div class="modal-backdrop" *ngIf="selectedOrder || isLoadingDetails" (click)="closeDetails()"></div>
<div class="modal" *ngIf="selectedOrder || isLoadingDetails" (click)="$event.stopPropagation()">
  <div class="modal-content">
    <div class="modal-header">
      <h2>
        <i class="fas fa-file-invoice"></i> Order #{{ selectedOrder?.id || '...' }}
      </h2>
      <button class="btn-icon" (click)="closeDetails()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Loading State -->
      <div *ngIf="isLoadingDetails" class="text-center py-5">
        <div class="spinner"></div>
        <p>Loading order details...</p>
      </div>

      <!-- Order Details -->
      <div *ngIf="selectedOrder && !isLoadingDetails">
        <!-- Customer Info Section -->
        <div class="detail-section">
          <h3 class="detail-section-title">
            <i class="fas fa-user"></i> Customer Information
          </h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Customer Name</span>
              <span class="detail-value">{{ selectedOrder.customerName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Phone (WhatsApp)</span>
              <span class="detail-value">
                <a [href]="'https://wa.me/' + selectedOrder.phoneNumber" target="_blank" class="phone-link">
                  <i class="fab fa-whatsapp"></i> {{ selectedOrder.phoneNumber }}
                </a>
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Payment Method</span>
              <span class="detail-value">
                <span class="payment-badge">
                  <i class="fas" [class]="getPaymentMethodIcon(selectedOrder.paymentMethod)"></i>
                  {{ getPaymentMethodLabel(selectedOrder.paymentMethod) }}
                </span>
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Order Date</span>
              <span class="detail-value">{{ selectedOrder.createdAt | date:'fullDate' }} • {{ selectedOrder.createdAt | date:'shortTime' }}</span>
            </div>
          </div>
        </div>

        <!-- Product Details Section -->
        <div class="detail-section" *ngIf="selectedOrder.vps || selectedOrder.dedicated">
          <h3 class="detail-section-title">
            <i class="fas fa-server"></i>
            {{ selectedOrder.vps ? 'VPS Plan Details' : 'Dedicated Server Details' }}
          </h3>

          <div class="product-details-card">
            <div class="product-header">
              <h4>{{ selectedOrder.vps?.name || selectedOrder.dedicated?.name }}</h4>
              <div class="product-price">
                ${{ selectedOrder.vps?.price || selectedOrder.dedicated?.price }}<span>/month</span>
              </div>
            </div>

            <div class="specs-grid">


              <div class="spec-item">
                <i class="fas fa-memory"></i>
                <div>
                  <strong>RAM</strong>
                  <span>{{ selectedOrder.vps?.ramGB || selectedOrder.dedicated?.ramGB }} GB DDR4</span>
                </div>
              </div>

              <div class="spec-item">
                <i class="fas fa-hdd"></i>
                <div>
                  <strong>Storage</strong>
                  <span *ngIf="selectedOrder.vps">
                    {{ selectedOrder.vps.storageGB }} GB {{ selectedOrder.vps.storageType || 'NVMe' }}
                  </span>
                  <span *ngIf="selectedOrder.dedicated">
                    {{ selectedOrder.dedicated.storage || '2×512 GB NVMe' }}
                  </span>
                </div>
              </div>

              <div class="spec-item" *ngIf="selectedOrder.dedicated">
                <i class="fas fa-network-wired"></i>
                <div>
                  <strong>Bandwidth</strong>
                  <span>{{ selectedOrder.dedicated.bandwidth || '1 Gbps Unmetered' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Description Section -->
        <div class="detail-section" *ngIf="selectedOrder.description">
          <h3 class="detail-section-title">
            <i class="fas fa-file-alt"></i> Order Summary
          </h3>
          <div class="description-box">
            <pre>{{ selectedOrder.description }}</pre>
          </div>
        </div>

        <!-- Payment Proof Section -->
        <div class="detail-section" *ngIf="selectedOrder.paymentConfirmationImageUrl">
          <h3 class="detail-section-title">
            <i class="fas fa-image"></i> Payment Confirmation
          </h3>
          <div class="payment-proof">
            <img [src]="selectedOrder.paymentConfirmationImageUrl" alt="Payment proof">
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-primary" (click)="closeDetails()">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>
</div>
