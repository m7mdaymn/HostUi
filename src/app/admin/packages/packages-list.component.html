<div class="admin-shell">
  <app-admin-sidebar></app-admin-sidebar>

  <div class="admin-content">
    <app-admin-topbar></app-admin-topbar>

    <main class="dashboard-main">
      <header class="dashboard-header">
        <div>
          <h1 class="title">Packages Management</h1>
          <p class="subtitle">Create and manage hosting packages</p>
        </div>
        <button class="btn-primary" (click)="openPackageModal()">
          <i class="fas fa-plus"></i> Add New Package
        </button>
      </header>

      <div class="card">
        <div class="card-body p-0">
          <!-- Loading / Empty / Error -->
          <div *ngIf="loading" class="loading-state">
            <div class="spinner"></div>
            <p>Loading packages...</p>
          </div>

          <div *ngIf="error" class="alert-danger m-4">{{ error }}</div>

          <div *ngIf="!loading && !packages.length && !error" class="empty-state">
            <h3>No packages found</h3>
            <p>Click "Add New Package" to create your first one.</p>
          </div>

          <!-- Packages Table -->
          <table class="data-table" *ngIf="packages.length">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Duration</th>
                <th>Price</th>
                <th>Description</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let pkg of packages; trackBy: trackByPackageId">
                <td><code class="id-badge">#{{ pkg.id }}</code></td>
                <td><strong>{{ pkg.name }}</strong></td>
                <td>{{ pkg.durationMonths }} months</td>
                <td><strong>${{ pkg.totalPrice | number:'1.2-2' }}</strong></td>
                <td class="muted">{{ pkg.description || '—' }}</td>
                <td class="actions-group">
                  <button class="btn-icon" (click)="openPackageModal(pkg)" title="Edit Package">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-icon" (click)="openItemsModal(pkg)" title="Manage Package Contents">
                    <i class="fas fa-cubes"></i>
                  </button>
                  <button class="btn-icon danger" (click)="confirmDelete(pkg)" title="Delete Package">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Backdrop -->
<div class="modal-backdrop" *ngIf="modalOpen || itemsModalOpen || deleteConfirmOpen" (click)="closeAllModals()">
</div>

<!-- Create/Edit Package Modal -->
<div class="modal" *ngIf="modalOpen" (click)="$event.stopPropagation()">
  <div class="modal-content">
    <div class="modal-header">
      <h2>{{ selectedPackage ? 'Edit' : 'Create' }} Package</h2>
      <button class="btn-icon" (click)="closePackageModal()"><i class="fas fa-times"></i></button>
    </div>
    <form [formGroup]="packageForm" (ngSubmit)="savePackage()" class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Name <span class="required">*</span></label>
          <input type="text" formControlName="name" placeholder="e.g. Starter VPS Package" />
        </div>
        <div class="form-group">
          <label>Duration (months) <span class="required">*</span></label>
          <input type="number" formControlName="durationMonths" />
        </div>
        <div class="form-group">
          <label>Total Price ($) <span class="required">*</span></label>
          <input type="number" step="0.01" formControlName="totalPrice" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" formControlName="description" placeholder="Optional description" />
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-outline" (click)="closePackageModal()" [disabled]="saving">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="saving || packageForm.invalid">
          <span *ngIf="saving" class="spinner-small"></span>
          {{ selectedPackage ? 'Save Changes' : 'Create Package' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Manage Package Items Modal - FULLY FIXED -->
<div class="modal modal-lg" *ngIf="itemsModalOpen" (click)="$event.stopPropagation()">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fas fa-cubes"></i> {{ selectedPackage?.name }} - Package Contents</h2>
      <button class="btn-icon" (click)="closeItemsModal()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-body">
      <!-- Add New Item Form -->
      <div class="add-item-section card mb-4">
        <h3 class="mb-4">Add Item to Package</h3>
        <form [formGroup]="itemForm" (ngSubmit)="addItem()" class="form-grid">
          <div class="form-group">
            <label>Product Type <span class="required">*</span></label>
            <select formControlName="productType" (change)="onProductTypeChange()">
              <option value="vps">VPS Server</option>
              <option value="dedicated">Dedicated Server</option>
            </select>
          </div>

          <div class="form-group">
            <label>Product <span class="required">*</span></label>
            <select formControlName="productId">
              <option value="">-- Select Product --</option>
              <option *ngFor="let prod of (itemForm.value.productType === 'vps' ? vps : dedicated)"
                      [value]="prod.id ?? prod._id">
                {{ prod.name || prod.brand || 'Unnamed' }}
                <span class="text-muted">({{ prod.ram }}GB RAM, {{ prod.cpu }} CPU)</span>
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Quantity <span class="required">*</span></label>
            <input type="number" formControlName="quantity" min="1" />
          </div>

          <div class="form-group">
            <label>Note (Optional)</label>
            <input type="text" formControlName="note" placeholder="e.g. Includes free setup" />
          </div>

          <div class="form-group" style="grid-column: span 2;">
            <button type="submit" class="btn-primary" [disabled]="itemForm.invalid">
              <i class="fas fa-plus"></i> Add Item
            </button>
          </div>
        </form>
      </div>

      <!-- Current Items List -->
      <div class="card">
        <div class="card-body p-0">
          <div *ngIf="items.length === 0" class="empty-state py-5">
            <h4>No items in this package yet</h4>
            <p>Use the form above to add VPS or Dedicated servers.</p>
          </div>

          <table class="data-table" *ngIf="items.length > 0">
            <thead>
              <tr>
                <th>Type</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Note</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of items">
                <td><strong>{{ item.displayType }}</strong></td>
                <td>
                  <div><strong>{{ item.productName }}</strong></div>
                  <small class="muted">{{ item.productDescription }}</small>
                </td>
                <td><strong>{{ item.quantity }}</strong></td>
                <td class="muted">{{ item.note || '—' }}</td>
                <td class="text-end">
                  <button class="btn-icon danger" (click)="deleteItem(item.id || item._id)" title="Remove Item">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-outline" (click)="closeItemsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal modal-sm" *ngIf="deleteConfirmOpen" (click)="$event.stopPropagation()">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Delete Package?</h3>
      <button class="btn-icon" (click)="deleteConfirmOpen = false"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body text-center py-5">
      <p>Are you sure you want to delete <strong>{{ deleteTarget?.name }}</strong>?</p>
      <p class="text-muted">This action cannot be undone.</p>
    </div>
    <div class="modal-actions">
      <button class="btn-outline" (click)="deleteConfirmOpen = false">Cancel</button>
      <button class="btn-primary bg-danger" (click)="deleteConfirmed()">Delete Package</button>
    </div>
  </div>
</div>
